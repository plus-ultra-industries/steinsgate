name: Engineer Codex

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: Issue number to implement
        required: true

permissions:
  contents: read
  issues: read

jobs:
  implement:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Build prompt from issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issueNumber = Number('${{ github.event.inputs.issue_number }}');
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            const prompt = [
              'You are the Engineer agent.',
              'Implement this issue with minimal, focused code changes.',
              'Add/update tests if relevant.',
              '',
              `Issue #${issue.number}: ${issue.title}`,
              issue.body || ''
            ].join('\n');
            fs.mkdirSync('darkfactory/runtime', { recursive: true });
            fs.writeFileSync('darkfactory/runtime/prompt.md', prompt);

      - name: Preflight secret check
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "OPENAI_API_KEY secret is empty or missing" >&2
            exit 1
          fi
          echo "OPENAI_API_KEY present"

      - name: Run Codex (official action)
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: darkfactory/runtime/prompt.md
          sandbox: workspace-write
          safety-strategy: drop-sudo
